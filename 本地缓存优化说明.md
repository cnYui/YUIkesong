# æœ¬åœ°ç¼“å­˜ä¼˜åŒ– - æå‡åº”ç”¨æ€§èƒ½

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆåº”ç”¨æ¯æ¬¡ç‚¹å‡»æŒ‰é’®åç­‰å¾…æ—¶é—´å¤ªé•¿ï¼Œå› ä¸ºæ¯æ¬¡éƒ½ä»æ•°æ®åº“é‡æ–°æŸ¥è¯¢ã€‚å¸Œæœ›å°†å¤©æ°”ã€ç”¨æˆ·å¤´åƒã€åç§°ç­‰æ•°æ®ä¿å­˜åœ¨æµè§ˆå™¨ç¼“å­˜ä¸­ï¼Œå‡å°‘æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚

## è§£å†³æ–¹æ¡ˆ

### âœ… å®ç°å†…å®¹

1. **æ·»åŠ æœ¬åœ°ç¼“å­˜æœåŠ¡** (`CacheService`)
   - ä½¿ç”¨ `shared_preferences` åŒ…å®ç°æœ¬åœ°æŒä¹…åŒ–å­˜å‚¨
   - æ”¯æŒç”¨æˆ·ä¿¡æ¯ç¼“å­˜ï¼ˆ24å°æ—¶æœ‰æ•ˆæœŸï¼‰
   - æ”¯æŒå¤©æ°”ä¿¡æ¯ç¼“å­˜ï¼ˆ1å°æ—¶æœ‰æ•ˆæœŸï¼‰
   - è‡ªåŠ¨è¿‡æœŸç®¡ç†

2. **ä¼˜åŒ–ç”¨æˆ·ä¿¡æ¯åŠ è½½**
   - ç™»å½•æ—¶å…ˆæ˜¾ç¤ºç¼“å­˜æ•°æ®ï¼ˆç«‹å³æ˜¾ç¤ºï¼‰
   - åå°ä»æœåŠ¡å™¨è·å–æœ€æ–°æ•°æ®ï¼ˆé™é»˜æ›´æ–°ï¼‰
   - ç¼“å­˜ç”¨æˆ·æ˜µç§°å’Œå¤´åƒURL

3. **ä¼˜åŒ–å¤©æ°”ä¿¡æ¯åŠ è½½**
   - åŒé‡ç¼“å­˜æœºåˆ¶ï¼šæœ¬åœ°ç¼“å­˜ï¼ˆå¿«é€Ÿï¼‰+ æ•°æ®åº“ç¼“å­˜ï¼ˆæŒä¹…åŒ–ï¼‰
   - ä¼˜å…ˆä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼Œå…¶æ¬¡æ•°æ®åº“ç¼“å­˜
   - è‡ªåŠ¨åˆ·æ–°æœºåˆ¶ï¼ˆæ¯å°æ—¶ï¼‰

4. **ä¼˜åŒ–å¤´åƒæ˜¾ç¤º**
   - ProfilePage ä¼˜å…ˆä½¿ç”¨ AuthService ä¸­çš„ç¼“å­˜å¤´åƒ
   - åå°æ›´æ–°æœ€æ–°å¤´åƒ

## æŠ€æœ¯å®ç°

### 1. ç¼“å­˜æœåŠ¡ (`CacheService`)

**æ–‡ä»¶**: `stitch_flutter/lib/services/cache_service.dart`

#### åŠŸèƒ½ç‰¹æ€§

- âœ… ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ï¼ˆ24å°æ—¶æœ‰æ•ˆæœŸï¼‰
- âœ… å¤©æ°”ä¿¡æ¯ç¼“å­˜ï¼ˆ1å°æ—¶æœ‰æ•ˆæœŸï¼‰
- âœ… é€šç”¨ç¼“å­˜æ–¹æ³•ï¼ˆæ”¯æŒè‡ªå®šä¹‰è¿‡æœŸæ—¶é—´ï¼‰
- âœ… è‡ªåŠ¨è¿‡æœŸç®¡ç†
- âœ… æ¸…é™¤ç¼“å­˜åŠŸèƒ½

#### ä½¿ç”¨ç¤ºä¾‹

```dart
// ç¼“å­˜ç”¨æˆ·ä¿¡æ¯
await CacheService().cacheUserProfile(
  userId: 'user123',
  nickname: 'å¼ ä¸‰',
  avatarUrl: 'https://example.com/avatar.jpg',
);

// è·å–ç¼“å­˜çš„ç”¨æˆ·ä¿¡æ¯
final cachedProfile = CacheService().getCachedUserProfile('user123');
if (cachedProfile != null) {
  final nickname = cachedProfile['nickname'];
  final avatarUrl = cachedProfile['avatar_url'];
}

// ç¼“å­˜å¤©æ°”ä¿¡æ¯
await CacheService().cacheWeather(
  cityCode: '110000',
  weatherData: {
    'province': 'åŒ—äº¬',
    'city': 'åŒ—äº¬å¸‚',
    'weather': 'æ™´',
    'temperature': '20',
    // ...
  },
);

// è·å–ç¼“å­˜çš„å¤©æ°”ä¿¡æ¯
final cachedWeather = CacheService().getCachedWeather('110000');
```

### 2. è®¤è¯æœåŠ¡ä¼˜åŒ– (`AuthService`)

**æ–‡ä»¶**: `stitch_flutter/lib/services/auth_service.dart`

#### ä¼˜åŒ–ç­–ç•¥

**ä¿®æ”¹å‰**:
```dart
void login(String token) {
  ApiService.setToken(token);
  _isAuthenticated = true;
  _loadUserProfile();  // âŒ å¿…é¡»ç­‰å¾…æœåŠ¡å™¨å“åº”
  notifyListeners();
}
```

**ä¿®æ”¹å**:
```dart
void login(String token, {String? userId}) {
  ApiService.setToken(token);
  _isAuthenticated = true;
  _userId = userId;
  
  // âœ… å…ˆæ˜¾ç¤ºç¼“å­˜æ•°æ®ï¼ˆç«‹å³æ˜¾ç¤ºï¼‰
  _loadUserProfileFromCache();
  
  // âœ… åå°æ›´æ–°æœ€æ–°æ•°æ®
  _loadUserProfile();
  notifyListeners();
}
```

#### ç¼“å­˜æµç¨‹

1. **ç™»å½•æ—¶**:
   - ç«‹å³ä»ç¼“å­˜åŠ è½½ç”¨æˆ·ä¿¡æ¯ â†’ å¿«é€Ÿæ˜¾ç¤º
   - åå°ä»æœåŠ¡å™¨è·å–æœ€æ–°ä¿¡æ¯ â†’ é™é»˜æ›´æ–°

2. **é€€å‡ºç™»å½•æ—¶**:
   - æ¸…é™¤ç”¨æˆ·ä¿¡æ¯ç¼“å­˜

3. **æ£€æŸ¥ç™»å½•çŠ¶æ€æ—¶**:
   - å…ˆåŠ è½½ç¼“å­˜ â†’ å¿«é€Ÿæ˜¾ç¤º
   - åå°æ›´æ–° â†’ ç¡®ä¿æ•°æ®æœ€æ–°

### 3. å¤©æ°”ç»„ä»¶ä¼˜åŒ– (`WeatherWidget`)

**æ–‡ä»¶**: `stitch_flutter/lib/widgets/weather_widget.dart`

#### åŒé‡ç¼“å­˜æœºåˆ¶

```
ç”¨æˆ·æ‰“å¼€åº”ç”¨
    â†“
1. æ£€æŸ¥æœ¬åœ°ç¼“å­˜ï¼ˆshared_preferencesï¼‰
   â”œâ”€ æœ‰ç¼“å­˜ â†’ ç«‹å³æ˜¾ç¤º âœ…
   â””â”€ æ— ç¼“å­˜ â†’ ç»§ç»­
       â†“
2. æ£€æŸ¥æ•°æ®åº“ç¼“å­˜
   â”œâ”€ æœ‰ç¼“å­˜ â†’ æ˜¾ç¤º + ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜ âœ…
   â””â”€ æ— ç¼“å­˜ â†’ è°ƒç”¨API
       â†“
3. APIè·å–æˆåŠŸ
   â”œâ”€ ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜ï¼ˆå¿«é€Ÿè®¿é—®ï¼‰
   â””â”€ ä¿å­˜åˆ°æ•°æ®åº“ç¼“å­˜ï¼ˆæŒä¹…åŒ–ï¼‰
```

#### ç¼“å­˜ç­–ç•¥

- **æœ¬åœ°ç¼“å­˜** (`shared_preferences`): 1å°æ—¶æœ‰æ•ˆæœŸï¼Œå¿«é€Ÿè®¿é—®
- **æ•°æ®åº“ç¼“å­˜**: æŒä¹…åŒ–å­˜å‚¨ï¼Œè·¨è®¾å¤‡åŒæ­¥
- **è‡ªåŠ¨åˆ·æ–°**: æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡ï¼Œè¿‡æœŸè‡ªåŠ¨æ›´æ–°

### 4. ç™»å½•é¡µé¢ä¼˜åŒ–

**æ–‡ä»¶**: `stitch_flutter/lib/pages/login_page.dart`

#### ä¿®æ”¹å†…å®¹

```dart
// ç™»å½•æˆåŠŸåä¼ é€’ userId
final userId = data['user']['id']?.toString() ?? data['user_id']?.toString();
AuthService().login(data['token'], userId: userId);
```

### 5. ä¸ªäººèµ„æ–™é¡µä¼˜åŒ–

**æ–‡ä»¶**: `stitch_flutter/lib/pages/profile_page.dart`

#### ä¼˜åŒ–ç­–ç•¥

```dart
Future<void> _loadDefaultAvatar() async {
  // âœ… å…ˆå°è¯•ä» AuthService è·å–ç¼“å­˜çš„å¤´åƒ
  final authService = AuthService();
  if (authService.avatarUrl != null && authService.avatarUrl!.isNotEmpty) {
    // ç«‹å³æ˜¾ç¤ºç¼“å­˜çš„å¤´åƒ
    setState(() {
      _defaultAvatarUrl = authService.avatarUrl;
      _isLoadingAvatar = false;
    });
    // åå°æ›´æ–°æœ€æ–°å¤´åƒ
    _loadDefaultAvatarFromServer();
    return;
  }
  
  // å¦‚æœç¼“å­˜æ²¡æœ‰ï¼Œä»æœåŠ¡å™¨åŠ è½½
  await _loadDefaultAvatarFromServer();
}
```

## æ€§èƒ½æå‡

### ç”¨æˆ·ä½“éªŒæ”¹è¿›

| åœºæ™¯ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| **ç™»å½•åæ˜¾ç¤ºæ˜µç§°** | ç­‰å¾…æœåŠ¡å™¨å“åº”ï¼ˆ500-1000msï¼‰ | ç«‹å³æ˜¾ç¤ºç¼“å­˜ï¼ˆ<10msï¼‰ |
| **æ‰“å¼€é¦–é¡µæ˜¾ç¤ºå¤©æ°”** | ç­‰å¾…APIè°ƒç”¨ï¼ˆ1000-2000msï¼‰ | ç«‹å³æ˜¾ç¤ºç¼“å­˜ï¼ˆ<10msï¼‰ |
| **æŸ¥çœ‹ä¸ªäººèµ„æ–™** | ç­‰å¾…æ•°æ®åº“æŸ¥è¯¢ï¼ˆ300-500msï¼‰ | ç«‹å³æ˜¾ç¤ºç¼“å­˜ï¼ˆ<10msï¼‰ |
| **åˆ‡æ¢é¡µé¢** | æ¯æ¬¡éƒ½é‡æ–°æŸ¥è¯¢ | ä½¿ç”¨ç¼“å­˜ï¼Œæ— éœ€ç­‰å¾… |

### ç½‘ç»œè¯·æ±‚å‡å°‘

- **ç”¨æˆ·ä¿¡æ¯**: ä»æ¯æ¬¡ç™»å½•æŸ¥è¯¢ â†’ 24å°æ—¶å†…åªæŸ¥è¯¢1æ¬¡
- **å¤©æ°”ä¿¡æ¯**: ä»æ¯æ¬¡æ‰“å¼€æŸ¥è¯¢ â†’ 1å°æ—¶å†…åªæŸ¥è¯¢1æ¬¡
- **å¤´åƒä¿¡æ¯**: ä»æ¯æ¬¡æŸ¥çœ‹æŸ¥è¯¢ â†’ ä½¿ç”¨å†…å­˜ç¼“å­˜

## ç¼“å­˜ç­–ç•¥

### ç”¨æˆ·ä¿¡æ¯ç¼“å­˜

- **æœ‰æ•ˆæœŸ**: 24å°æ—¶
- **å­˜å‚¨ä½ç½®**: `shared_preferences` (key: `user_profile_{userId}`)
- **æ›´æ–°æ—¶æœº**: 
  - ç™»å½•æ—¶
  - ç”¨æˆ·æ›´æ–°èµ„æ–™æ—¶
  - ç¼“å­˜è¿‡æœŸæ—¶

### å¤©æ°”ä¿¡æ¯ç¼“å­˜

- **æœ‰æ•ˆæœŸ**: 1å°æ—¶
- **å­˜å‚¨ä½ç½®**: 
  - æœ¬åœ°: `shared_preferences` (key: `weather_{cityCode}`)
  - æ•°æ®åº“: `profiles.cached_weather`
- **æ›´æ–°æ—¶æœº**:
  - ç”¨æˆ·æ›´æ”¹åŸå¸‚æ—¶ï¼ˆå¼ºåˆ¶åˆ·æ–°ï¼‰
  - ç¼“å­˜è¿‡æœŸæ—¶ï¼ˆè‡ªåŠ¨åˆ·æ–°ï¼‰
  - æ¯å°æ—¶å®šæ—¶æ£€æŸ¥

## ä»£ç ä¿®æ”¹æ¸…å•

### æ–°å¢æ–‡ä»¶

- âœ… `stitch_flutter/lib/services/cache_service.dart` - ç¼“å­˜æœåŠ¡

### ä¿®æ”¹æ–‡ä»¶

- âœ… `stitch_flutter/pubspec.yaml` - æ·»åŠ  `shared_preferences` ä¾èµ–
- âœ… `stitch_flutter/lib/services/auth_service.dart` - ä½¿ç”¨ç¼“å­˜
- âœ… `stitch_flutter/lib/pages/login_page.dart` - ä¼ é€’ userId
- âœ… `stitch_flutter/lib/pages/profile_page.dart` - ä½¿ç”¨ç¼“å­˜å¤´åƒ
- âœ… `stitch_flutter/lib/widgets/weather_widget.dart` - åŒé‡ç¼“å­˜æœºåˆ¶

## ä½¿ç”¨æŒ‡å—

### å¼€å‘ç¯å¢ƒè®¾ç½®

1. **å®‰è£…ä¾èµ–**:
```bash
cd stitch_flutter
flutter pub get
```

2. **è¿è¡Œåº”ç”¨**:
```bash
flutter run
```

### æµ‹è¯•ç¼“å­˜åŠŸèƒ½

1. **æµ‹è¯•ç”¨æˆ·ä¿¡æ¯ç¼“å­˜**:
   - ç™»å½•åº”ç”¨
   - æŸ¥çœ‹é¦–é¡µæ˜µç§°ï¼ˆåº”è¯¥ç«‹å³æ˜¾ç¤ºï¼‰
   - é€€å‡ºç™»å½•
   - é‡æ–°ç™»å½•ï¼ˆåº”è¯¥ç«‹å³æ˜¾ç¤ºä¸Šæ¬¡çš„æ˜µç§°ï¼‰

2. **æµ‹è¯•å¤©æ°”ç¼“å­˜**:
   - æ‰“å¼€é¦–é¡µ
   - æŸ¥çœ‹å¤©æ°”ä¿¡æ¯ï¼ˆåº”è¯¥ç«‹å³æ˜¾ç¤ºï¼‰
   - ç­‰å¾…1å°æ—¶åï¼Œå¤©æ°”è‡ªåŠ¨åˆ·æ–°

3. **æµ‹è¯•å¤´åƒç¼“å­˜**:
   - æ‰“å¼€ä¸ªäººèµ„æ–™é¡µ
   - æŸ¥çœ‹å¤´åƒï¼ˆåº”è¯¥ç«‹å³æ˜¾ç¤ºï¼‰
   - åˆ‡æ¢é¡µé¢å†å›æ¥ï¼ˆåº”è¯¥ç«‹å³æ˜¾ç¤ºï¼Œæ— éœ€é‡æ–°åŠ è½½ï¼‰

## æ³¨æ„äº‹é¡¹

1. **ç¼“å­˜è¿‡æœŸ**: ç¼“å­˜ä¼šè‡ªåŠ¨è¿‡æœŸï¼Œç¡®ä¿æ•°æ®ä¸ä¼šå¤ªæ—§
2. **ç½‘ç»œå¤±è´¥**: å¦‚æœç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œä¼šç»§ç»­ä½¿ç”¨ç¼“å­˜æ•°æ®
3. **æ•°æ®åŒæ­¥**: æœ¬åœ°ç¼“å­˜å’Œæ•°æ®åº“ç¼“å­˜å¯èƒ½ä¸åŒæ­¥ï¼Œä¼˜å…ˆä½¿ç”¨æœ¬åœ°ç¼“å­˜
4. **æ¸…é™¤ç¼“å­˜**: é€€å‡ºç™»å½•æ—¶ä¼šè‡ªåŠ¨æ¸…é™¤ç”¨æˆ·ä¿¡æ¯ç¼“å­˜

## åç»­ä¼˜åŒ–å»ºè®®

1. **å›¾ç‰‡ç¼“å­˜**: ä½¿ç”¨ `cached_network_image` åŒ…ç¼“å­˜ç½‘ç»œå›¾ç‰‡
2. **ç¦»çº¿æ”¯æŒ**: å®ç°å®Œæ•´çš„ç¦»çº¿æ¨¡å¼ï¼Œæ”¯æŒç¦»çº¿æµè§ˆ
3. **ç¼“å­˜å‹ç¼©**: å¯¹å¤§å‹æ•°æ®è¿›è¡Œå‹ç¼©å­˜å‚¨
4. **ç¼“å­˜ç»Ÿè®¡**: æ·»åŠ ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡ï¼Œä¼˜åŒ–ç¼“å­˜ç­–ç•¥
5. **æ™ºèƒ½é¢„åŠ è½½**: é¢„æµ‹ç”¨æˆ·è¡Œä¸ºï¼Œæå‰åŠ è½½å¯èƒ½éœ€è¦çš„æ•°æ®

## æŠ€æœ¯ç»†èŠ‚

### shared_preferences å­˜å‚¨æ ¼å¼

```json
{
  "user_profile_user123": {
    "nickname": "å¼ ä¸‰",
    "avatar_url": "https://example.com/avatar.jpg",
    "cached_at": "2024-01-01T00:00:00Z"
  },
  "weather_110000": {
    "weather_data": {
      "province": "åŒ—äº¬",
      "city": "åŒ—äº¬å¸‚",
      "weather": "æ™´",
      "temperature": "20"
    },
    "cached_at": "2024-01-01T00:00:00Z"
  }
}
```

### ç¼“å­˜é”®å‘½åè§„èŒƒ

- ç”¨æˆ·ä¿¡æ¯: `user_profile_{userId}`
- å¤©æ°”ä¿¡æ¯: `weather_{cityCode}`
- å…¶ä»–æ•°æ®: `{prefix}_{identifier}`

## æ€»ç»“

é€šè¿‡å®ç°æœ¬åœ°ç¼“å­˜æœºåˆ¶ï¼Œåº”ç”¨æ€§èƒ½å¾—åˆ°æ˜¾è‘—æå‡ï¼š

- âœ… **å“åº”é€Ÿåº¦**: ä»ç§’çº§é™ä½åˆ°æ¯«ç§’çº§
- âœ… **ç”¨æˆ·ä½“éªŒ**: ç«‹å³æ˜¾ç¤ºå†…å®¹ï¼Œæ— éœ€ç­‰å¾…
- âœ… **ç½‘ç»œè¯·æ±‚**: å¤§å¹…å‡å°‘ä¸å¿…è¦çš„APIè°ƒç”¨
- âœ… **ç¦»çº¿æ”¯æŒ**: éƒ¨åˆ†åŠŸèƒ½æ”¯æŒç¦»çº¿ä½¿ç”¨

ç”¨æˆ·ç°åœ¨å¯ä»¥äº«å—æ›´æµç•…ã€æ›´å¿«é€Ÿçš„åº”ç”¨ä½“éªŒï¼ğŸ‰

