# 社区图片显示优化 - 衣服图片大图展示

## 问题描述

用户在保存穿搭时不仅保存了生成的造型图，还保存了使用的衣服搭配。但是在发布到社区后，其他用户浏览帖子时只能看到造型图，无法看到具体的衣服款式。

用户希望：
- 发布穿搭时，造型图和衣服图片一起发布
- 在帖子详情页，衣服图片作为大图展示（而不是小图）
- 用户可以左右滑动查看所有图片

## 解决方案

### ✅ 后端已实现的功能

#### 1. 发布穿搭时保存所有图片

**文件**: `backend/api/routes/saved-looks.js`

```javascript
// 发布保存穿搭到社区
app.post('/saved-looks/:id/publish', authenticateToken, async (req, res) => {
  // ... 查询保存穿搭和衣物数据 ...

  // 创建帖子图片记录
  const postImages = [
    {
      id: uuidv4(),
      post_id: postId,
      image_url: savedLook.cover_image_url,  // 第一张：造型图
      sort_order: 0
    }
  ];

  // 添加衣物图片
  if (wardrobeImages.length > 0) {
    wardrobeImages.forEach((imageUrl, index) => {
      postImages.push({
        id: uuidv4(),
        post_id: postId,
        image_url: imageUrl,              // 后续：衣服单品图
        sort_order: index + 1
      });
    });
  }

  // 插入到 community_post_images 表
  await supabase
    .from('community_post_images')
    .insert(postImages);
});
```

#### 2. 帖子详情接口返回所有图片 ✅

**文件**: `backend/api/routes/community.js`

```javascript
// GET /community/posts/:id
app.get('/community/posts/:id', authenticateToken, async (req, res) => {
  // 获取帖子图片
  const { data: images } = await supabase
    .from('community_post_images')
    .select('image_url, sort_order')
    .eq('post_id', id)
    .order('sort_order', { ascending: true });

  res.json({
    id: post.id,
    images: (images || []).map(img => img.image_url),  // ✅ 返回所有图片
    // ...
  });
});
```

### ❌ 修复的问题

#### 社区列表接口只返回封面图

**修改前**:
```javascript
// GET /community/posts
const formattedPosts = await Promise.all((posts || []).map(async (post) => {
  // ...
  return {
    id: post.id,
    cover_image_url: post.cover_image_url,  // ❌ 只有封面图
    username: post.profiles.nickname,
    avatar: post.profiles.avatar_url,
    // ...
  };
}));
```

**修改后**:
```javascript
// GET /community/posts
const formattedPosts = await Promise.all((posts || []).map(async (post) => {
  // 获取帖子图片（包括造型图和衣服图片）
  const { data: images } = await supabase
    .from('community_post_images')
    .select('image_url, sort_order')
    .eq('post_id', post.id)
    .order('sort_order', { ascending: true });

  return {
    id: post.id,
    cover_image_url: post.cover_image_url,
    images: (images || []).map(img => img.image_url),  // ✅ 返回所有图片
    username: post.profiles.nickname,
    avatar: post.profiles.avatar_url,
    // ...
  };
}));
```

### ✅ 前端已实现的功能

#### 1. 社区页面传递完整图片数组

**文件**: `stitch_flutter/lib/pages/community_page.dart`

```dart
// 处理帖子数据
final List<dynamic> imagesData = [];

// 如果返回的是完整的帖子详情（包含images数组）
if (item['images'] != null && item['images'] is List) {
  imagesData.addAll(item['images']);  // ✅ 使用完整图片数组
} else {
  // 否则只有封面图（向后兼容）
  if (item['cover_image_url'] != null) {
    imagesData.add({'image_url': item['cover_image_url']});
  }
}

// 导航到详情页
Navigator.of(context).push(
  MaterialPageRoute(
    builder: (_) => PostDetailPage(
      postId: post.id,
      images: post.images,  // ✅ 传递所有图片
      username: post.username,
      avatar: post.avatar,
    ),
  ),
);
```

#### 2. 帖子详情页显示所有图片

**文件**: `stitch_flutter/lib/pages/post_detail_page.dart`

```dart
// 图片轮播（带底部指示器）
Stack(
  children: [
    // 图片轮播
    PageView.builder(
      controller: _pageController,
      itemCount: widget.images.length,  // ✅ 显示所有图片
      onPageChanged: (index) => setState(() => _currentImageIndex = index),
      itemBuilder: (context, index) {
        return Image.network(
          _getImageUrl(widget.images[index]),
          fit: BoxFit.cover,
        );
      },
    ),
    // 底部指示器（悬浮在图片上）
    if (widget.images.length > 1)
      Positioned(
        bottom: 16,
        left: 0,
        right: 0,
        child: Row(
          mainAxisAlignment: MainAxisAlignment.center,
          children: List.generate(widget.images.length, (index) {
            final selected = index == _currentImageIndex;
            return AnimatedContainer(
              duration: const Duration(milliseconds: 200),
              width: selected ? 24 : 8,
              height: 8,
              decoration: BoxDecoration(
                color: selected 
                    ? Colors.white 
                    : Colors.white.withOpacity(0.5),
                borderRadius: BorderRadius.circular(999),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black.withOpacity(0.2),
                    blurRadius: 4,
                    offset: const Offset(0, 2),
                  ),
                ],
              ),
            );
          }),
        ),
      ),
  ],
)
```

## 数据流程

### 1. 用户保存穿搭

```
用户选择衣服 → AI生成造型图 → 保存
↓
saved_looks 表
├── id
├── cover_image_url (造型图)
└── saved_look_items
    └── wardrobe_item_id (衣服ID)
```

### 2. 用户发布到社区

```
点击"发布到社区"
↓
后端查询
├── saved_looks (获取造型图)
└── saved_look_items + wardrobe_items (获取衣服图片)
↓
创建帖子
├── community_posts (帖子基本信息)
└── community_post_images
    ├── [0] 造型图 (sort_order: 0)
    ├── [1] 衣服1 (sort_order: 1)
    ├── [2] 衣服2 (sort_order: 2)
    └── [3] 衣服3 (sort_order: 3)
```

### 3. 其他用户浏览社区

```
打开社区页面
↓
GET /community/posts
├── 查询 community_posts
└── 对每个帖子查询 community_post_images (NEW!)
↓
返回完整图片数组
[造型图, 衣服1, 衣服2, 衣服3]
↓
点击帖子进入详情
↓
PageView显示所有图片（可左右滑动）
```

## UI 效果

### 社区列表页
- 显示封面图（造型图）作为预览
- 图片下方显示点赞、评论数

### 帖子详情页
- 第1张：完整造型图
- 第2张：背心单品大图
- 第3张：裤子单品大图
- ...
- 底部白色指示器显示当前位置
- 左右滑动查看所有图片

## 测试步骤

1. **准备测试数据**
   - 在衣橱中添加几件衣服（上衣、裤子等）
   - 在AI试衣间选择多件衣服
   - 生成造型并保存

2. **发布到社区**
   - 进入"我保存的穿搭"页面
   - 选择一套穿搭，点击"发布到社区"
   - 查看是否提示发布成功

3. **查看社区列表**
   - 进入社区页面
   - 确认可以看到刚发布的帖子
   - 封面图应该是造型效果图

4. **查看帖子详情**
   - 点击帖子进入详情页
   - 确认可以看到第一张造型图
   - 向左滑动，确认可以看到衣服单品大图
   - 底部指示器应该正确显示当前位置（白色圆点）

5. **多图片切换**
   - 左右滑动查看所有图片
   - 指示器应该平滑动画过渡
   - 当前图片的指示器更长（24px）

## 技术细节

### 数据库表结构

#### community_post_images
```sql
CREATE TABLE community_post_images (
  id UUID PRIMARY KEY,
  post_id UUID REFERENCES community_posts(id),
  image_url TEXT NOT NULL,
  sort_order INT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_post_images_post_id ON community_post_images(post_id);
CREATE INDEX idx_post_images_sort ON community_post_images(post_id, sort_order);
```

### API 接口

#### GET /community/posts
**返回格式**:
```json
{
  "list": [
    {
      "id": "xxx",
      "cover_image_url": "造型图URL",
      "images": ["造型图URL", "衣服1URL", "衣服2URL"],
      "username": "用户名",
      "avatar": "头像URL",
      "description": "描述",
      "likes_count": 10,
      "comments_count": 5,
      "is_liked": false
    }
  ],
  "page": 1,
  "pageSize": 6,
  "total": 20
}
```

#### GET /community/posts/:id
**返回格式**:
```json
{
  "id": "xxx",
  "images": ["造型图URL", "衣服1URL", "衣服2URL"],
  "username": "用户名",
  "avatar": "头像URL",
  "description": "描述",
  "likes_count": 10,
  "comments_count": 5,
  "is_liked": false,
  "created_at": "2024-01-01T00:00:00Z"
}
```

## 修改文件清单

### 后端修改
- ✅ `backend/api/routes/saved-looks.js` - 发布逻辑（已实现）
- ✅ `backend/api/routes/community.js` - 列表接口添加图片数组（本次修改）
- ✅ `backend/api/routes/community.js` - 详情接口返回图片数组（已实现）

### 前端修改
- ✅ `stitch_flutter/lib/pages/community_page.dart` - 处理图片数组（已实现）
- ✅ `stitch_flutter/lib/pages/post_detail_page.dart` - 图片轮播和指示器（已实现）

## 性能优化建议

1. **图片懒加载**: `PageView.builder` 已实现懒加载
2. **图片缓存**: 使用 `cached_network_image` 包
3. **缩略图**: 在列表页使用压缩的缩略图
4. **预加载**: 预加载相邻图片以提升滑动体验

## 后续功能扩展

1. **图片预览**: 点击图片进入全屏预览模式
2. **图片保存**: 长按保存单张图片到相册
3. **图片标签**: 为每张衣服图片添加品牌、价格标签
4. **购买链接**: 点击衣服图片跳转到购买页面
5. **图片说明**: 为每张图片添加独立的说明文字

