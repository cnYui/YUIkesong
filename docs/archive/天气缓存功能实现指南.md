# 天气缓存功能实现指南

## 问题描述

当用户选择城市后，高德地图天气API可能因为网络问题导致加载失败，显示"网络错误"。为了提升用户体验，需要在数据库中缓存上一次成功获取的天气信息。

## 解决方案

实现天气缓存机制，包括：
1. 在数据库中添加天气缓存字段
2. 后端提供保存和读取天气缓存的API
3. 前端在API失败时自动使用缓存数据

## 实现步骤

### 步骤1: 执行数据库迁移

在Supabase控制台的SQL Editor中执行以下SQL：

```sql
-- 添加天气缓存字段到 profiles 表

-- 添加天气缓存字段（使用 JSONB 存储完整的天气信息）
ALTER TABLE public.profiles 
ADD COLUMN IF NOT EXISTS cached_weather JSONB;

-- 添加天气缓存更新时间
ALTER TABLE public.profiles 
ADD COLUMN IF NOT EXISTS weather_updated_at TIMESTAMP;

-- 创建索引以提高查询性能
CREATE INDEX IF NOT EXISTS idx_profiles_weather_updated 
ON public.profiles(weather_updated_at);

-- 添加注释说明
COMMENT ON COLUMN public.profiles.cached_weather IS '缓存的天气信息，包含: province, city, adcode, weather, temperature, windDirection, windPower, humidity, reportTime';
COMMENT ON COLUMN public.profiles.weather_updated_at IS '天气信息最后更新时间';
```

### 步骤2: 验证数据库修改

执行以下SQL验证字段已添加：

```sql
SELECT 
    column_name,
    data_type,
    is_nullable,
    column_default
FROM information_schema.columns
WHERE table_schema = 'public' 
  AND table_name = 'profiles'
ORDER BY ordinal_position;
```

你应该看到新增的列：
- `cached_weather` (jsonb)
- `weather_updated_at` (timestamp without time zone)

### 步骤3: 重启后端服务

后端服务已经更新，包含天气缓存相关的API端点。确保后端正在运行：

```bash
cd backend/api
npm start
```

### 步骤4: 重新运行Flutter应用

```bash
flutter run
```

## 工作原理

### 1. 天气获取流程

```
用户选择城市
    ↓
加载缓存的天气(如果有) → 立即显示
    ↓
尝试调用高德地图API
    ↓
┌─────────────┴─────────────┐
↓ API成功                     ↓ API失败
更新显示最新天气           使用缓存的天气
保存到数据库缓存           显示"上次更新时间"
```

### 2. 后端API

#### 保存天气缓存
```
POST /weather/cache
Authorization: Bearer {token}
Body: {
  "weatherData": {
    "province": "江苏",
    "city": "南京市",
    "adcode": "320100",
    "weather": "晴",
    "temperature": "20",
    "windDirection": "东北",
    "windPower": "≤3",
    "humidity": "65",
    "reportTime": "2024-11-14 15:30:00"
  }
}
```

#### 获取天气缓存
```
GET /weather/cache
Authorization: Bearer {token}
Response: {
  "weatherData": { ... },
  "updatedAt": "2024-11-14T07:30:00.000Z"
}
```

### 3. 前端逻辑

#### WeatherWidget

```dart
// 1. 页面加载时
- 先从数据库获取缓存的天气 → 立即显示(如果有)
- 然后调用API获取最新天气 → 更新显示并保存到缓存

// 2. API成功
- 显示最新天气
- 保存到数据库缓存

// 3. API失败
- 如果有缓存，显示缓存的天气
- 如果没有缓存，显示错误消息
```

## 用户体验改进

### 改进前
- 网络失败 → 显示"网络错误"
- 用户看不到任何天气信息
- 体验差

### 改进后
- 页面加载 → 立即显示缓存的天气（如果有）
- 后台尝试更新 → 成功则更新显示
- 网络失败 → 继续显示缓存的天气
- 用户始终能看到天气信息
- 体验流畅

## 数据结构

### cached_weather (JSONB)
```json
{
  "province": "江苏",
  "city": "南京市",
  "adcode": "320100",
  "weather": "晴",
  "temperature": "20",
  "windDirection": "东北",
  "windPower": "≤3",
  "humidity": "65",
  "reportTime": "2024-11-14 15:30:00"
}
```

### weather_updated_at (TIMESTAMP)
天气信息最后更新的时间戳，用于：
- 判断缓存是否过期
- 显示"上次更新时间"
- 统计分析

## 测试步骤

### 1. 正常场景测试
1. 登录应用
2. 选择一个城市（如南京市）
3. 等待天气加载成功
4. 验证：天气信息正确显示

### 2. 缓存测试
1. 成功加载天气后
2. 断开网络或关闭高德API
3. 退出应用并重新打开
4. 验证：立即显示缓存的天气信息

### 3. API失败测试
1. 断开网络
2. 选择一个新城市
3. 验证：如果之前有该城市的缓存，显示缓存；否则显示错误

### 4. 缓存更新测试
1. 有缓存的情况下打开应用
2. 观察：先显示缓存的天气
3. 等待：后台API成功后，天气信息自动更新

## 调试日志

代码中已添加详细的调试日志，查看Flutter控制台输出：

```
✅ 使用缓存的天气数据           // 从数据库加载缓存
📍 使用用户选择的城市: 南京市    // 调用API
✅ 天气获取成功，保存到缓存      // API成功，保存缓存
✅ 天气缓存保存成功             // 缓存保存成功
❌ 加载天气异常: ...           // API失败
✅ API失败，使用缓存的天气数据  // 使用缓存作为降级方案
```

## 注意事项

1. **缓存有效性**: 当前实现没有设置缓存过期时间，你可以根据需求添加（例如：缓存超过1小时则强制刷新）

2. **网络检测**: 可以考虑添加网络状态检测，在无网络时直接使用缓存，避免不必要的API调用

3. **错误处理**: 缓存保存失败不会影响天气显示，确保用户体验不受影响

4. **数据一致性**: 天气数据存储在profiles表中，与用户绑定，确保不同用户的天气数据互不干扰

## 技术细节

### 为什么使用JSONB？

- 灵活性：天气数据结构可能变化，JSONB无需修改表结构
- 查询能力：PostgreSQL的JSONB支持高效的JSON查询
- 存储效率：JSONB是二进制格式，比TEXT更高效

### 为什么分离cache和updated_at？

- 性能：查询updated_at字段创建索引，加快查询速度
- 扩展性：未来可以根据updated_at实现缓存过期策略
- 清晰性：时间戳独立存储，逻辑更清晰

## 未来改进

1. **缓存过期策略**: 添加缓存有效期（如1小时），过期后强制刷新
2. **离线模式**: 检测网络状态，离线时直接使用缓存
3. **缓存版本**: 添加版本号，支持缓存数据结构的升级
4. **多城市缓存**: 支持缓存多个城市的天气信息
5. **后台自动更新**: 应用在后台时定期更新天气缓存

