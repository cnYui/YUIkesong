# 保存穿搭衣物图片不显示问题排查报告

## 问题描述
用户在"我的衣柜"页面选择衣服后保存到"我保存的穿搭"页面，之前能够显示衣服的图片（3张照片，超过3张可以左右拖拽），但现在不显示了。

## 问题根因分析

### 1. 数据字段不匹配问题
后端数据库中衣物表（`wardrobe_items`）存储的是 `image_path`（Supabase存储路径），但前端和API之间传递的有两种URL：
- `image_path`: 存储路径，如 `wardrobe/user-id/timestamp_filename.jpg`
- `image_url`: 公开访问URL，如 `https://xxx.supabase.co/storage/v1/object/public/wardrobe/...`

### 2. 具体问题点

#### 问题1：前端传递错误的字段
**位置**: `stitch_flutter/lib/pages/wardrobe_page.dart` 第64行

**原代码**:
```dart
imageMap[i] = _clothingItems[i]['image_url'] ?? '';
```

**问题**: 前端将 `image_url` 传递给后端，但后端在创建穿搭关联时（`backend/api/routes/saved-looks.js` 第46行）使用以下查询：
```javascript
.in('image_path', clothing_image_urls)
```

这导致无法匹配到衣物记录，因为 `image_url` 和 `image_path` 是不同的值。

#### 问题2：后端查询结果解析不完整
**位置**: `backend/api/routes/saved-looks.js` 第102行

**原代码**:
```javascript
const clothingImageUrls = items ? items.map(item => item.wardrobe_items.image_path) : [];
```

**问题**: 没有处理 `wardrobe_items` 可能是数组或查询失败返回null的情况。

## 修复方案

### 修复1：前端使用正确的字段
**文件**: `stitch_flutter/lib/pages/wardrobe_page.dart`

**修改内容**:
```dart
// 使用image_path而不是image_url，因为后端需要用这个字段匹配
imageMap[i] = _clothingItems[i]['image_path'] ?? '';
```

### 修复2：后端增加日志和错误处理
**文件**: `backend/api/routes/saved-looks.js`

**修改内容**:
1. 在创建穿搭关联时增加详细日志：
```javascript
console.log('开始保存衣物关联，衣物图片URLs:', clothing_image_urls);
console.log('查询到的衣柜物品:', wardrobeItems, '错误:', itemsError);
```

2. 按原始URL顺序创建关联记录，保持衣物顺序：
```javascript
const lookItems = clothing_image_urls.map((url, index) => {
  const wardrobeItem = wardrobeItems.find(item => item.image_path === url);
  if (wardrobeItem) {
    return {
      saved_look_id: savedLookId,
      wardrobe_item_id: wardrobeItem.id,
      slot: `slot_${index + 1}`
    };
  }
  return null;
}).filter(item => item !== null);
```

3. 在获取穿搭列表时增加健壮性处理：
```javascript
const clothingImageUrls = items ? items.map(item => {
  // 处理wardrobe_items可能是对象或数组的情况
  const imagePath = Array.isArray(item.wardrobe_items) 
    ? item.wardrobe_items[0]?.image_path 
    : item.wardrobe_items?.image_path;
  console.log(`衣物项 ${item.wardrobe_item_id} 的图片路径:`, imagePath);
  return imagePath;
}).filter(path => path) : [];
```

### 修复3：前端显示时转换路径为URL
**文件**: `stitch_flutter/lib/pages/saved_looks_page.dart`

**修改内容**:
在 `_SavedLookCard` 组件中添加URL转换函数：
```dart
String _getImageUrl(String imagePath) {
  // 如果已经是完整URL，直接返回
  if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
    return imagePath;
  }
  // 否则构造Supabase公开URL
  const supabaseUrl = 'https://tbjyhqcazhgcmtbdgwpg.supabase.co';
  return '$supabaseUrl/storage/v1/object/public/wardrobe/$imagePath';
}
```

并在所有图片显示处使用该函数：
```dart
Image.network(
  _getImageUrl(look.resultImage),
  // ...
)
```

## 测试步骤

1. **重启后端服务器**
   ```bash
   cd backend/api
   npm start
   ```

2. **清理前端缓存并重新运行**
   ```bash
   cd stitch_flutter
   flutter clean
   flutter pub get
   flutter run -d chrome
   ```

3. **测试流程**
   - 登录系统
   - 进入"我的衣柜"页面
   - 选择3件以上的衣服（测试横向滚动）
   - 点击"一键生成"跳转到AI试穿室
   - 在AI试穿室点击"保存穿搭"
   - 进入"我保存的穿搭"页面
   - **验证点**：
     - 每个穿搭卡片下方应该显示选中的衣物图片
     - 如果衣物数量≤2，应该横向排列
     - 如果衣物数量>2，应该可以左右滑动查看
     - 图片应该能正常加载显示

4. **查看后端日志**
   查看控制台输出，确认：
   - 保存穿搭时有正确的日志输出
   - 衣物图片路径正确匹配到衣柜物品
   - 关联记录成功插入

5. **查看前端日志**
   打开浏览器开发者工具Console，确认：
   - 获取穿搭列表时有正确的日志输出
   - 衣物图片路径正确解析
   - 如果图片加载失败，会有错误日志

## 预期结果
- 保存的穿搭应该显示用户选择的衣物图片
- 衣物图片顺序应该与选择时的顺序一致
- 超过2张图片时可以横向滚动查看
- 所有图片应该正常加载显示

## 回滚方案
如果修复后仍有问题，可以通过以下方式回滚：

```bash
# 回滚到上一次提交
git reset --hard HEAD~1

# 或查看git日志选择特定提交
git log
git reset --hard <commit-hash>
```

## 相关文件清单
- `stitch_flutter/lib/pages/wardrobe_page.dart` - 衣柜选择逻辑
- `stitch_flutter/lib/pages/ai_fitting_room_page.dart` - AI试穿室保存逻辑
- `stitch_flutter/lib/pages/saved_looks_page.dart` - 保存穿搭显示逻辑
- `stitch_flutter/lib/state/wardrobe_selection_store.dart` - 衣柜选择状态管理
- `stitch_flutter/lib/state/saved_looks_store.dart` - 保存穿搭状态管理
- `backend/api/routes/saved-looks.js` - 保存穿搭后端API
- `backend/api/routes/wardrobe.js` - 衣柜后端API

