# ç™»å½•çŠ¶æ€æ£€æŸ¥ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

ç”¨æˆ·åœ¨æœªç™»å½•çŠ¶æ€ä¸‹è®¿é—®åº”ç”¨æ—¶ï¼Œç³»ç»Ÿä¼šå°è¯•è°ƒç”¨éœ€è¦è®¤è¯çš„APIæ¥å£ï¼Œå¯¼è‡´401é”™è¯¯ï¼š

```
åŠ è½½ç¤¾åŒºå¸–å­å¤±è´¥: Exception: è·å–ç¤¾åŒºå¸–å­åˆ—è¡¨å¤±è´¥: 401
```

## âœ… ä¿®å¤å†…å®¹

### 1. **ç¤¾åŒºé¡µé¢ï¼ˆCommunityPageï¼‰**
**ä¿®å¤å‰ï¼š**
- `initState` ç›´æ¥è°ƒç”¨ `_loadCommunityPosts`ï¼Œä¸æ£€æŸ¥ç™»å½•çŠ¶æ€
- æœªç™»å½•ç”¨æˆ·ä¼šæ”¶åˆ°401é”™è¯¯

**ä¿®å¤åï¼š**
```dart
@override
void initState() {
  super.initState();
  // åªæœ‰åœ¨å·²ç™»å½•æ—¶æ‰åŠ è½½ç¤¾åŒºå¸–å­
  if (ApiService.isAuthenticated) {
    _loadCommunityPosts(isRefresh: true);
  }
}

/// åŠ è½½ç¤¾åŒºå¸–å­
Future<void> _loadCommunityPosts({bool isRefresh = false}) async {
  // æ£€æŸ¥ç™»å½•çŠ¶æ€
  if (!ApiService.isAuthenticated) {
    if (mounted) {
      setState(() {
        _isLoading = false;
        _error = 'è¯·å…ˆç™»å½•';
      });
    }
    return;
  }
  // ... å…¶ä½™ä»£ç 
}
```

**UIæ”¹è¿›ï¼š**
- æœªç™»å½•æ—¶æ˜¾ç¤ºå‹å¥½çš„ç™»å½•å¼•å¯¼ç•Œé¢
- åŒ…å«"å‰å¾€ç™»å½•"æŒ‰é’®ï¼Œç‚¹å‡»è·³è½¬åˆ°ç™»å½•é¡µé¢

### 2. **å¤©æ°”ç»„ä»¶ï¼ˆWeatherWidgetï¼‰**
**å·²ç»æ­£ç¡®å®ç°ï¼š**
```dart
void _checkAuthAndLoadWeather() {
  final authService = AuthService();
  
  // å¦‚æœå·²ç™»å½•ï¼Œä»æ•°æ®åº“åŠ è½½ä¿å­˜çš„åŸå¸‚ï¼Œç„¶ååŠ è½½å¤©æ°”
  if (authService.isAuthenticated) {
    _loadWeatherFromDatabase();
    return;
  }

  // å¦‚æœæœªç™»å½•ï¼Œç›‘å¬ç™»å½•çŠ¶æ€å˜åŒ–
  authService.addListener(_onAuthChanged);
  
  // æ˜¾ç¤ºæœªç™»å½•çŠ¶æ€
  if (!_hasCheckedAuth) {
    _hasCheckedAuth = true;
    if (mounted) {
      setState(() {
        _isLoading = false;
      });
    }
  }
}
```

**UIæ˜¾ç¤ºï¼š**
- æœªç™»å½•ï¼šæ˜¾ç¤º"ç™»å½•åæŸ¥çœ‹å¤©æ°”"
- å·²ç™»å½•ï¼šæ­£å¸¸æ˜¾ç¤ºå¤©æ°”ä¿¡æ¯

### 3. **è¡£æŸœé¡µé¢ï¼ˆWardrobePageï¼‰**
**å·²ç»æ­£ç¡®å®ç°ï¼š**
```dart
Future<void> _loadClothingItems() async {
  try {
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
    if (!ApiService.isAuthenticated) {
      setState(() {
        _error = 'è¯·å…ˆç™»å½•ä»¥æŸ¥çœ‹æ‚¨çš„è¡£æŸœ';
        _isLoading = false;
      });
      return;
    }
    // ... å…¶ä½™ä»£ç 
  }
}
```

### 4. **ä¸ªäººèµ„æ–™é¡µé¢ï¼ˆProfilePageï¼‰**
**å·²ç»æ­£ç¡®å®ç°ï¼š**
```dart
@override
void didChangeDependencies() {
  super.didChangeDependencies();
  // å½“é¡µé¢å¯è§ä¸”ç”¨æˆ·å·²ç™»å½•æ—¶åŠ è½½å¤´åƒ
  if (ApiService.isAuthenticated && _defaultAvatarUrl == null && !_isLoadingAvatar) {
    _loadDefaultAvatar();
  }
}

Future<void> _loadDefaultAvatar() async {
  if (!ApiService.isAuthenticated) {
    return;
  }
  // ... å…¶ä½™ä»£ç 
}
```

### 5. **AIè¯•ç©¿å®¤é¡µé¢ï¼ˆAiFittingRoomPageï¼‰**
**å·²ç»æ­£ç¡®å®ç°ï¼š**
```dart
/// ç”Ÿæˆè¯•ç©¿å›¾ç‰‡
Future<void> _generateFittingImage() async {
  // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
  if (!ApiService.isAuthenticated) {
    if (mounted) {
      setState(() {
        _errorMessage = 'è¯·å…ˆç™»å½•';
      });
    }
    return;
  }
  // ... å…¶ä½™ä»£ç 
}
```

## ğŸ“‹ æ£€æŸ¥æ¸…å•

| é¡µé¢/ç»„ä»¶ | æ£€æŸ¥ä½ç½® | çŠ¶æ€ | è¯´æ˜ |
|---------|---------|------|------|
| CommunityPage | initState, _loadCommunityPosts | âœ… å·²ä¿®å¤ | æ·»åŠ ç™»å½•æ£€æŸ¥å’Œå‹å¥½UI |
| WeatherWidget | _checkAuthAndLoadWeather | âœ… å·²å®ç° | æ­£ç¡®å¤„ç†æœªç™»å½•çŠ¶æ€ |
| WardrobePage | _loadClothingItems | âœ… å·²å®ç° | æœ‰ç™»å½•æ£€æŸ¥ |
| ProfilePage | didChangeDependencies, _loadDefaultAvatar | âœ… å·²å®ç° | æœ‰ç™»å½•æ£€æŸ¥ |
| AiFittingRoomPage | _generateFittingImage | âœ… å·²å®ç° | æœ‰ç™»å½•æ£€æŸ¥ |
| HomePage | æ— APIè°ƒç”¨ | âœ… æ— éœ€ä¿®æ”¹ | ä½¿ç”¨é™æ€æ•°æ® |

## ğŸ” éªŒè¯æ–¹æ³•

### æµ‹è¯•æ­¥éª¤

1. **æ¸…é™¤åº”ç”¨æ•°æ®/é‡æ–°å®‰è£…åº”ç”¨**
2. **å¯åŠ¨åº”ç”¨ï¼ˆæœªç™»å½•çŠ¶æ€ï¼‰**
3. **ä¾æ¬¡è®¿é—®å„ä¸ªTabé¡µé¢ï¼š**
   - é¦–é¡µï¼šâœ… åº”æ­£å¸¸æ˜¾ç¤ºï¼ˆä½¿ç”¨é™æ€æ¨èæ•°æ®ï¼‰
   - è¡£æŸœï¼šâœ… æ˜¾ç¤º"è¯·å…ˆç™»å½•ä»¥æŸ¥çœ‹æ‚¨çš„è¡£æŸœ"
   - ç¤¾åŒºï¼šâœ… æ˜¾ç¤º"è¯·å…ˆç™»å½•æŸ¥çœ‹ç¤¾åŒºå†…å®¹"ï¼Œå¸¦æœ‰"å‰å¾€ç™»å½•"æŒ‰é’®
   - AIè¯•ç©¿å®¤ï¼šâœ… ä¸è‡ªåŠ¨ç”Ÿæˆï¼Œç‚¹å‡»ç”Ÿæˆæ—¶æç¤º"è¯·å…ˆç™»å½•"
   - æˆ‘çš„ï¼šâœ… æ˜¾ç¤ºé»˜è®¤å¤´åƒï¼Œä¸åŠ è½½ç”¨æˆ·æ•°æ®

4. **æ£€æŸ¥æ§åˆ¶å°ï¼š**
   - âŒ ä¸åº”å‡ºç°401é”™è¯¯
   - âŒ ä¸åº”å‡ºç°APIè°ƒç”¨å¤±è´¥é”™è¯¯
   - âœ… å¯èƒ½å‡ºç°"ç”¨æˆ·æœªç™»å½•"çš„æ—¥å¿—ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼‰

5. **ç™»å½•åï¼š**
   - âœ… æ‰€æœ‰é¡µé¢åº”æ­£å¸¸åŠ è½½æ•°æ®
   - âœ… å¤©æ°”ä¿¡æ¯åº”æ­£å¸¸æ˜¾ç¤º
   - âœ… ç¤¾åŒºå¸–å­åº”æ­£å¸¸æ˜¾ç¤º

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**æ‰€æœ‰éœ€è¦åç«¯æ•°æ®çš„æ“ä½œéƒ½å¿…é¡»å…ˆæ£€æŸ¥ç™»å½•çŠ¶æ€ï¼š**

1. **åœ¨ initState ä¸­ï¼š**
```dart
@override
void initState() {
  super.initState();
  if (ApiService.isAuthenticated) {
    _loadData();
  }
}
```

2. **åœ¨æ•°æ®åŠ è½½å‡½æ•°ä¸­ï¼š**
```dart
Future<void> _loadData() async {
  if (!ApiService.isAuthenticated) {
    setState(() {
      _error = 'è¯·å…ˆç™»å½•';
      _isLoading = false;
    });
    return;
  }
  // ç»§ç»­åŠ è½½æ•°æ®...
}
```

3. **åœ¨ç”¨æˆ·æ“ä½œè§¦å‘çš„APIè°ƒç”¨ä¸­ï¼š**
```dart
Future<void> _handleUserAction() async {
  if (!ApiService.isAuthenticated) {
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('è¯·å…ˆç™»å½•')),
    );
    return;
  }
  // æ‰§è¡Œæ“ä½œ...
}
```

## ğŸš¨ å¸¸è§é”™è¯¯åœºæ™¯

### âŒ é”™è¯¯ç¤ºä¾‹1ï¼šç›´æ¥åœ¨initStateä¸­è°ƒç”¨API
```dart
@override
void initState() {
  super.initState();
  _loadData(); // é”™è¯¯ï¼æœªæ£€æŸ¥ç™»å½•çŠ¶æ€
}
```

### âŒ é”™è¯¯ç¤ºä¾‹2ï¼šåªåœ¨ä¸€å¤„æ£€æŸ¥
```dart
@override
void initState() {
  super.initState();
  if (ApiService.isAuthenticated) {
    _loadData(); // åœ¨initStateæ£€æŸ¥äº†
  }
}

Future<void> _loadData() async {
  // ä½†è¿™é‡Œæ²¡æœ‰æ£€æŸ¥ï¼ç”¨æˆ·å¯èƒ½åœ¨å…¶ä»–åœ°æ–¹è°ƒç”¨è¿™ä¸ªæ–¹æ³•
  final data = await ApiService.getData();
}
```

### âœ… æ­£ç¡®ç¤ºä¾‹ï¼šåŒé‡æ£€æŸ¥
```dart
@override
void initState() {
  super.initState();
  if (ApiService.isAuthenticated) {
    _loadData();
  }
}

Future<void> _loadData() async {
  // è¿™é‡Œä¹Ÿè¦æ£€æŸ¥ï¼Œç¡®ä¿å®‰å…¨
  if (!ApiService.isAuthenticated) {
    return;
  }
  final data = await ApiService.getData();
}
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç›‘å¬å™¨ç®¡ç†ï¼š**
   - å¦‚æœä½¿ç”¨ `AuthService().addListener()`ï¼Œå¿…é¡»åœ¨ `dispose` ä¸­ç§»é™¤
   - ç¡®ä¿åœ¨çŠ¶æ€æ›´æ–°å‰æ£€æŸ¥ `mounted`

2. **é”™è¯¯æç¤ºï¼š**
   - æœªç™»å½•é”™è¯¯åº”è¯¥æ˜¾ç¤ºå‹å¥½æç¤ºï¼Œè€Œä¸æ˜¯æŠ€æœ¯é”™è¯¯ä¿¡æ¯
   - æä¾›"å‰å¾€ç™»å½•"çš„å¿«æ·å…¥å£

3. **çŠ¶æ€åŒæ­¥ï¼š**
   - ç™»å½•åï¼Œç›¸å…³é¡µé¢åº”è‡ªåŠ¨åˆ·æ–°æ•°æ®
   - å¯ä»¥ä½¿ç”¨ `AuthService` çš„ç›‘å¬å™¨å®ç°

4. **æµ‹è¯•è¦†ç›–ï¼š**
   - æ¯ä¸ªé¡µé¢éƒ½è¦æµ‹è¯•æœªç™»å½•å’Œå·²ç™»å½•ä¸¤ç§çŠ¶æ€
   - æµ‹è¯•ç™»å½•çŠ¶æ€å˜åŒ–æ—¶çš„è¡Œä¸ºï¼ˆç™»å½•â†’ç™»å‡ºâ†’å†ç™»å½•ï¼‰

## ğŸ”§ åç»­ä¼˜åŒ–å»ºè®®

1. **ç»Ÿä¸€é”™è¯¯å¤„ç†ï¼š**
   - åˆ›å»ºç»Ÿä¸€çš„ `AuthGuard` widget
   - è‡ªåŠ¨å¤„ç†æœªç™»å½•çŠ¶æ€çš„UIæ˜¾ç¤º

2. **è‡ªåŠ¨è·³è½¬ï¼š**
   - æœªç™»å½•ç”¨æˆ·è®¿é—®éœ€è¦è®¤è¯çš„é¡µé¢æ—¶ï¼Œè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ
   - ç™»å½•æˆåŠŸåè¿”å›åŸé¡µé¢

3. **ç¼“å­˜ç­–ç•¥ï¼š**
   - å¯¹äºä¸æ•æ„Ÿçš„æ•°æ®ï¼Œå¯ä»¥åœ¨æœ¬åœ°ç¼“å­˜
   - æœªç™»å½•æ—¶æ˜¾ç¤ºç¼“å­˜æ•°æ®ï¼Œä½†æ ‡æ³¨ä¸º"éœ€è¦ç™»å½•ä»¥åˆ·æ–°"

4. **æ€§èƒ½ä¼˜åŒ–ï¼š**
   - é¿å…é‡å¤çš„ç™»å½•çŠ¶æ€æ£€æŸ¥
   - ä½¿ç”¨ `StreamBuilder` æˆ– `ValueListenableBuilder` å“åº”ç™»å½•çŠ¶æ€å˜åŒ–

---

**ä¿®å¤å®Œæˆæ—¶é—´ï¼š** 2024å¹´11æœˆ14æ—¥  
**æµ‹è¯•çŠ¶æ€ï¼š** âœ… å·²é€šè¿‡åŸºæœ¬æµ‹è¯•  
**éƒ¨ç½²çŠ¶æ€ï¼š** âœ… å¯ä»¥éƒ¨ç½²

