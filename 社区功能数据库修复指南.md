# 社区功能数据库修复指南

## 问题描述

社区帖子加载失败，返回500错误。根本原因是数据库中缺少外键约束，导致Supabase无法执行关联查询。

### 错误信息
```
Could not find a relationship between 'community_posts' and 'profiles' in the schema cache
```

## 解决方案

需要在Supabase数据库中添加外键约束。

### 步骤1: 登录Supabase控制台

1. 打开浏览器，访问: https://app.supabase.com/
2. 登录你的账号
3. 选择你的项目 (tbjyhqcazhgcmtbdgwpg)

### 步骤2: 打开SQL编辑器

1. 在左侧菜单中，点击 **SQL Editor**
2. 点击 **New query** 创建新查询

### 步骤3: 执行修复SQL

复制并执行以下SQL语句：

```sql
-- 添加外键约束以支持Supabase的关联查询

-- 1. 为 community_posts 添加外键到 profiles
ALTER TABLE public.community_posts 
DROP CONSTRAINT IF EXISTS community_posts_user_id_fkey;

ALTER TABLE public.community_posts 
ADD CONSTRAINT community_posts_user_id_fkey 
FOREIGN KEY (user_id) 
REFERENCES public.profiles(id) 
ON DELETE CASCADE;

-- 2. 为 community_post_images 添加外键到 community_posts
ALTER TABLE public.community_post_images 
DROP CONSTRAINT IF EXISTS community_post_images_post_id_fkey;

ALTER TABLE public.community_post_images 
ADD CONSTRAINT community_post_images_post_id_fkey 
FOREIGN KEY (post_id) 
REFERENCES public.community_posts(id) 
ON DELETE CASCADE;

-- 3. 为 community_likes 添加外键
ALTER TABLE public.community_likes 
DROP CONSTRAINT IF EXISTS community_likes_post_id_fkey;

ALTER TABLE public.community_likes 
ADD CONSTRAINT community_likes_post_id_fkey 
FOREIGN KEY (post_id) 
REFERENCES public.community_posts(id) 
ON DELETE CASCADE;

ALTER TABLE public.community_likes 
DROP CONSTRAINT IF EXISTS community_likes_user_id_fkey;

ALTER TABLE public.community_likes 
ADD CONSTRAINT community_likes_user_id_fkey 
FOREIGN KEY (user_id) 
REFERENCES public.profiles(id) 
ON DELETE CASCADE;

-- 4. 为 community_comments 添加外键
ALTER TABLE public.community_comments 
DROP CONSTRAINT IF EXISTS community_comments_post_id_fkey;

ALTER TABLE public.community_comments 
ADD CONSTRAINT community_comments_post_id_fkey 
FOREIGN KEY (post_id) 
REFERENCES public.community_posts(id) 
ON DELETE CASCADE;

ALTER TABLE public.community_comments 
DROP CONSTRAINT IF EXISTS community_comments_user_id_fkey;

ALTER TABLE public.community_comments 
ADD CONSTRAINT community_comments_user_id_fkey 
FOREIGN KEY (user_id) 
REFERENCES public.profiles(id) 
ON DELETE CASCADE;

ALTER TABLE public.community_comments 
DROP CONSTRAINT IF EXISTS community_comments_parent_id_fkey;

ALTER TABLE public.community_comments 
ADD CONSTRAINT community_comments_parent_id_fkey 
FOREIGN KEY (parent_id) 
REFERENCES public.community_comments(id) 
ON DELETE CASCADE;
```

### 步骤4: 验证修复

在SQL编辑器中执行以下查询，验证外键已成功创建：

```sql
SELECT
    tc.table_name, 
    kcu.column_name, 
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name 
FROM information_schema.table_constraints AS tc 
JOIN information_schema.key_column_usage AS kcu
  ON tc.constraint_name = kcu.constraint_name
  AND tc.table_schema = kcu.table_schema
JOIN information_schema.constraint_column_usage AS ccu
  ON ccu.constraint_name = tc.constraint_name
  AND ccu.table_schema = tc.table_schema
WHERE tc.constraint_type = 'FOREIGN KEY' 
  AND tc.table_name IN ('community_posts', 'community_post_images', 'community_likes', 'community_comments')
ORDER BY tc.table_name, kcu.column_name;
```

你应该看到类似这样的结果：

| table_name | column_name | foreign_table_name | foreign_column_name |
|---|---|---|---|
| community_comments | parent_id | community_comments | id |
| community_comments | post_id | community_posts | id |
| community_comments | user_id | profiles | id |
| community_likes | post_id | community_posts | id |
| community_likes | user_id | profiles | id |
| community_post_images | post_id | community_posts | id |
| community_posts | user_id | profiles | id |

### 步骤5: 测试

1. 确保后端服务正在运行 (如果没有，在 `backend/api` 目录运行 `npm start`)
2. 重启Flutter应用
3. 登录后访问社区页面
4. 现在应该能正常加载（虽然目前没有帖子，但不应该再显示500错误）

## 预期结果

修复后，社区页面应该：
- **如果有帖子**: 显示帖子列表
- **如果没有帖子**: 显示空白页面或提示信息（不会再显示500错误）

## 后续测试

修复后，你可以测试发布功能：
1. 进入"我保存的穿搭"页面
2. 选择一个穿搭
3. 点击"发布到社区"
4. 返回社区页面，应该能看到刚发布的内容

## 技术说明

**为什么会出现这个问题？**

Supabase使用PostgREST，它依赖数据库的外键关系来执行关联查询。当我们使用 `profiles!inner(nickname, avatar_url)` 这样的语法时，Supabase会在数据库元数据中查找 `community_posts.user_id` 到 `profiles.id` 的外键关系。如果没有这个外键，查询就会失败。

**为什么一开始没有外键？**

在初始的数据库模式文件中，我们创建表时没有定义外键约束（只定义了列，但没有 `REFERENCES` 子句）。这次修复补充了这些缺失的约束。

## 需要帮助？

如果遇到任何问题，请检查：
1. 后端日志（运行 `npm start` 的终端窗口）
2. Flutter控制台输出（我已经添加了详细的调试日志）
3. Supabase控制台的Table Editor，确认外键已创建

